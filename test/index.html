<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Spotify Premium</title>
	<link rel="stylesheet" href="style.css" />
	<script>
	var htmlobjs = ['abbr','article','aside','audio','canvas','datalist','details','figcaption','figure','footer','header','hgroup','mark','meter','nav','output','progress','section','summary','time','video'];
	for(i=htmlobjs.length;i>0;i--){
		document.createElement(htmlobjs[i-1]);
	}
	</script>
</head>
<body>
	<header id="header">
		<div class="controls">
			<a href="#back" class="back">back</a>
			<a href="#forward" class="forward">forward</a>
		</div>
		<form id="search">
			<input type="search" id="search-field"/>
			<button type="submit">Search</button>
		</form>
		<div id="user">
			<a href="#"><img class="avatar" src="#">Fredrik Gustafsson</a>
			<ul>
				<li><a href="#">Fredrik Gustafsson</a></li>
			</ul>
		</div>
	</header>
	<div id="content">
		<section id="playlists">
			<nav>
				<ul>
					<li><a class="news" href="#">Whats new</a></li>
					<li><a class="radio" href="#">Radio</a></li>
					<li><a class="queue" href="#">Play Queue</a></li>
					<li><a class="inbox" href="#">Inbox</a></li>
					<li><a class="devices" href="#">Devices</a></li>
				</ul>
				<ul>
					<li><a class="library" href="#">Library</a></li>
					<li><a class="starred" href="#">Starred</a></li>
					<li><a class="selected playlist" href="#">Playlist</a></li>
					<li><a class="playlist" href="#">Playlist 2</a></li>
				</ul>
				<ul>
					<li><a class="new-list" href="#">New Playlist</a></li>
				</ul>
			</nav>
			<section id="current">
				<a href="#">
					<figure>
						<img scr="coverart">
						<figcaption>
							<strong class="song">Song</strong>
							<span class="band">Band</span>
						</figcaption>
					</figure>
				</a>
			</section>
		</section>
		<section id="main">
			<header class="header">
					<h1>Playlist 1</h1>
			</header>
			<article>
				<figure class="coverart">
					<img src="#">
				</figure>
			</article>
			<section class="playlist">
				<table>
					<thead>
						<tr>
							<th align="center"/>
							<th>Track</th>
							<th>Get</th>
							<th>Artist</th>
							<th class="right">Time</th>
							<th>Album</th>
							<th />
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="star"><a class="stared" href="#">&#9733;</a></td>
							<td><a rel="song" href="song.mp3">I'm A Believer MP3</a></td>
							<td />
							<td><a href="#">The Monkees</a></td>
							<td class="right">2.44</td>
							<td><a href="#">The Definitive Monkees</a></td>
							<td />
						</tr>
						<tr>
							<td class="star"><a href="#">&#9733;</a></td>
							<td><a rel="song" href="song.ogg">I'm A Believer OGG</a></td>
							<td />
							<td><a href="#">The Monkees</a></td>
							<td class="right">2.44</td>
							<td><a href="#">The Definitive Monkees</a></td>
							<td />
						</tr>
						<tr>
							<td class="star"><a href="#">&#9733;</a></td>
							<td><a rel="song" href="song.ogg">I'm A Believer</a></td>
							<td />
							<td><a href="#">The Monkees</a></td>
							<td class="right">2.44</td>
							<td><a href="#">The Definitive Monkees</a></td>
							<td />
						</tr>
					</tbody>
				</table>
			</section>
		</section>
		<aside id="aside">
			<section id="friends">
				<header>
					<h2>People</h2>
				</header>
				<ul>
					<li><a href="#">Friend 1</a></li>
				</ul>
			</section>
		</aside>
	</div>
	<footer id="footer">
		<section id="player"></section>
	</footer>
	<script src="chainvas.js"></script>
	<script>
		// Append this to (parentNode) and return this
		Object.prototype.appendTo = function(refObj) { 
			refObj.appendChild(this);
			return this; 
		}
		// Insert this before (object) and return this, overrides the native insertBefore() and starts form the new element instead of its parent.
		Object.prototype.insertBefore = function(refObj) { 
			refObj.parentNode.insertBefore(this, refObj);
			return this;
		}
		// Insert this right after (object)
		Object.prototype.insertAfter = function(refObj) { 
			var parent = refObj.parentNode;
			if(refObj.nextSibling){
				parent.insertBefore(this, refObj.nextSibling);
			} else {
				parent.appendChild(this);
			}
			return this; 
		}
		// Remove object from DOM
		Object.prototype.remove = function() { 
			this.parentNode.removeChild(this);
			return this;
		}
		// Does this have (certain class)
		Object.prototype.hasClass = function(cls) {
			return this.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
		}
		// Add a (class) to this, if it isn't already there
		Object.prototype.addClass = function(cls) {
			if (!this.hasClass(cls)){
				this.className += " "+cls;
			}
			return this;
		}

		// Remove a (class) from this if it exists
		Object.prototype.removeClass = function(cls) {
			if (this.hasClass(cls)) {
				var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
				this.className=this.className.replace(reg,' ');
			}
			return this;
		}
		/**
		**	Extend this with these (JSON parameters), allowing more strucured object definitions
		*/
		Object.prototype.extend = function(json){
			for (var key in json){
				if (json.hasOwnProperty(key)) {
					this[key] = json[key];
				}
			}
		}
		//Tricgger mouseclick
		Object.prototype.triggerClick = function(){
			var evObj = document.createEvent('MouseEvents');
			evObj.initEvent( 'click', true, true );
			return this.dispatchEvent(evObj);
		}
		//indexOf for NOdeList as well
		NodeList.prototype.indexOf = function(node){
			for(var i=0,l=this.length;i<l;i++){
				if(this[i]===node){
					return i;
				}
			}
			return false;
		}
		// Calculate minutes and seconds from seconds
		function getTrackTime(time){
			var s = parseInt(time % 60);
		    if(parseInt(s)<10){
		    	s = '0'+s;
		    }
	    	var m = parseInt((time / 60) % 60);
	    	return m + ':' + s;
		}

		Object.prototype.Player = function(objSelector){
			var player = this;
			player.extend({
				obj : document.querySelector(objSelector),
				audio : document.createElement('audio'),
				activePlaylist : [],
				index : 0,
				currentTrack : false,
				updateTimeline : false,
				prevbtn : document.createElement('button').addClass('prev').prop({'innerHTML':'Prev', 'disabled':'disabled'}),
				playbtn : document.createElement('button').addClass('play').prop({'innerHTML':'Play', 'disabled':'disabled'}),
				nextbtn : document.createElement('button').addClass('next').prop({'innerHTML':'Next', 'disabled':'disabled'}),
				repeat : document.createElement('input').prop({'type':'checkbox', 'id':'repeat'}),
				shuffle : document.createElement('input').prop({'type':'checkbox', 'id':'shuffle'}),
				volume : document.createElement('input').addClass('volume').prop({'type':'range', 'max':100, 'value':100}),
				timeline : document.createElement('input').prop({'type':'range','disabled':'disabled', 'value':0, 'min':0}),
				duration : document.createElement('span').addClass('duration'),
				tracklength : document.createElement('span').addClass('tracklength'),
				enableControls : function(){
					this.prevbtn.removeAttribute('disabled');
					this.playbtn.removeAttribute('disabled');
					this.nextbtn.removeAttribute('disabled');
				},
				disableControls : function(){
					this.prevbtn.prop('disabled','disabled');
					this.playbtn.prop('disabled','disabled');
					this.nextbtn.prop('disabled','disabled');
				},
				setPLaylist : function(){
					
				},
				setCurrent : function(track){
					if (player.currentTrack){
						player.currentTrack.removeClass('current');
					}
					player.currentTrack = track;
					player.currentTrack.addClass('current');
					player.activePlaylist = player.currentTrack.parentNode.getElementsByTagName('tr');
					player.index = player.activePlaylist.indexOf(player.currentTrack);
				},
				loadSrc : function(src, callback){
					player.audio.prop('src', src).addEventListener('loadeddata', function(){
						player.enableControls();
						player.tracklength.prop('innerHTML', getTrackTime(player.audio.duration))
							.insertAfter(player.timeline.prop('max', player.audio.duration).removeAttribute('disabled'));
						player.updateTimeline = true;
						if(typeof(callback) === 'function'){
							callback();
						}
					});
				},
				play : function(){
					return player.audio.play();
				},
				pause : function(){
					return player.audio.pause();
				},
				stop : function(){
					player.pause();
					player.timeline.prop('value', 0);
					player.duration.remove();
					player.tracklength.remove();
					player.audio.removeAttribute('src');
					player.disableControls();
					player.timeline.prop('disabled', 'disabled');
					player.activePlaylist = [];
					player.index = 0;
					player.currentTrack.removeClass('current')
					player.currentTrack = false;
				},
				nextTrack : function(){
					if(player.activePlaylist.length>player.index+1){
						player.index++;
					} else if(player.repeat.checked){
						player.index = 0;
					} else {
						player.stop();
						return false;
					}
					player.activePlaylist[player.index].querySelector('a[rel=song]').triggerClick();
				},
				prevTrack : function(){
					if(player.index>0){
						player.index--;
						player.activePlaylist[player.index].querySelector('a[rel=song]').triggerClick();
					}
				}
			});
			function init(){
				player.audio.addEventListener('play', function(){
						player.playbtn.prop({'innerHTML':'Pause', 'className':'pause'});
					})
					.addEventListener('pause', function(){
						player.playbtn.prop({'innerHTML':'Play', 'className':'play'});	
					})
					.addEventListener('timeupdate', function(){
						player.duration.prop('innerHTML',getTrackTime(player.audio.currentTime)).insertAfter(player.timeline);
					    if(player.updateTimeline){
					    	player.timeline.value = player.audio.currentTime;
					    }
					}, false)
					.addEventListener('ended', function(){
						player.pause();
						player.nextTrack();
					}, false);
				player.timeline.addEventListener("mousedown", function(){
					player.updateTimeline = false;
				}, false).addEventListener("mouseup", function(){
					player.pause();
					player.audio.currentTime = player.timeline.value;
					player.play();
					player.updateTimeline = true;
				}, false);
				player.prevbtn.addEventListener('click', function(){
					player.prevTrack();
				}, false).appendTo(player.obj);

				player.playbtn.addEventListener('click', function(){
					if(!player.audio.paused){
						player.pause();
					} else {
						player.play();
					}
				}, false).appendTo(player.obj);
				
				player.nextbtn.addEventListener('click', function(){
					player.nextTrack();
				}, false).appendTo(player.obj);
				player.shuffle.appendTo(document.createElement('div').addClass('playmode').appendTo(player.obj));
				player.repeat.insertAfter(player.shuffle);
				document.createElement('label').setAttribute('for','shuffle').prop({'innerHTML':'Shuffle', 'className':'shuffle'}).insertAfter(player.shuffle);
				document.createElement('label').setAttribute('for','repeat').prop({'innerHTML':'Repeat', 'className':'repeat'}).insertAfter(player.repeat);

				player.volume.appendTo(document.createElement('div').prop('id','volume-container').appendTo(player.obj));
				player.timeline.appendTo(document.createElement('div').prop('id','timeline-container').appendTo(player.obj));
				player.volume.setVolume().addEventListener('change', function(){
					this.setVolume();
					player.audio.volume = this.value/100; 
				});
			}
			Object.prototype.setVolume = function(){
				if(this.value<25){
					this.parentNode.className = 'low';
				} else if(this.value<60){
					this.parentNode.className = 'medium';
				} else if(this.value>75){
					this.parentNode.className = 'high';
				}
				return this;
			}
			return init();
		}
		var trackmouse = function(e){
			console.log(e.pageX);
		};
		Object.prototype.resizable = function(sibling, handles){
			for (var i = 0; i < handles.length; i++) {
				var obj = this,
				direction = handles[i],
				interval,
				handle = document.createElement('span').prop({'draggable':'true','className':direction+'-resize'}).appendTo(obj),
				start;
				handle.addEventListener('dragstart', function (event) {
					start = event.pageX;
					this.addClass('dragging');
				}, false).addEventListener('dragend', function (event) {
					this.removeClass('dragging');
					if(direction == 'w'){
						obj.style.width = aside.clientWidth+(start-event.pageX)+'px';
						sibling.style.right = obj.style.width;
					} else if(direction == 'e'){
						obj.style.width = aside.clientWidth+(event.pageX-start)+'px';
						sibling.style.left = obj.style.width;
					}
				});		
			}
		};
		document.addEventListener('DOMContentLoaded', function(){
			var player = new Player('#player');
			document.body.addEventListener('click', function(e){
				if(e.target.tagName === 'A' && e.target.rel === 'song'){
					e.preventDefault();
					player.loadSrc(e.target.href, function(){
						player.setCurrent(e.target.parentNode.parentNode);
						player.play();
					});
				}
			}).addEventListener('dragover', function(e){
				e.preventDefault();
				this.addClass('dragover');
				return false;
			}).addEventListener('dragend', function(e){
				e.preventDefault();
				this.removeClass('dragover');
				return false;
			}).addEventListener('drop', function(e){
				e.preventDefault();
				var file = e.dataTransfer.files[0];
				var reader = new FileReader();
				reader.onload = function(ev){
				 	alert(ev.target.result);
				}
				reader.readAsDataURL(file);
				return false;				
			}, false);
			var main = document.getElementById('main'),
			nav = document.getElementById('playlists').resizable(main, ['e']),
			aside = document.getElementById('aside').resizable(main, ['w']);
		}, false);
		/*var audio = document.getElementById('audio');
		var playpause = document.getElementById('playpause');
		var timeline = document.getElementById('timeline'); 
		var duration = document.getElementById('duration');
		var tracklength = document.getElementById("tracklength");
		var updateTimeline = true;
		var playlists = document.getElementById("playlists");
		var aside = document.getElementById("aside");
		document.body.addEventListener('click', function(e){
			if(e.target.tagName === 'A' && e.target.rel === 'song'){
				e.preventDefault();
				alert(e.target.href);
			}
		});
		audio.addEventListener('ended', function(){
    	playpause.className = "play";
		}, false);
		playpause.onclick = function(){
			if(!audio.paused){
				audio.pause();
				playpause.className = "pause";
			} else {
				setTrack();
				audio.play();
				playpause.className = "play";
			}
		}
		// Get where one are in playback and push the time to an element
		audio.addEventListener("timeupdate", function() {
		    duration.innerHTML = getTrackTime(audio.currentTime);
		    if(updateTimeline){
		    	timeline.value = audio.currentTime;
		    }
		}, false);
		timeline.addEventListener("mousedown", function(){
			updateTimeline = false;
		}, false);
		timeline.addEventListener("mouseup", function(){
			audio.pause();
			audio.currentTime = timeline.value;
			audio.play();
			updateTimeline = true;
		}, false);
		function setTrack(){
			tracklength.innerHTML = getTrackTime(audio.duration);
			timeline.max = audio.duration;
			timeline.removeAttribute('disabled');
		}
		*/
	</script>
</body>
</html>